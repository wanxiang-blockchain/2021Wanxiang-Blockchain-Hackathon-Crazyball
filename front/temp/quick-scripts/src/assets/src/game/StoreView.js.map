{"version":3,"sources":["assets/src/game/StoreView.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["const { WalletAccount, keyStores, connect, Contract } = window.nearApi;\nimport State from './model/State';\n\nconst { ccclass, property } = cc._decorator;\n@ccclass\nexport default class StoreView extends cc.Component {\n  @property(cc.Node)\n  goBack: cc.Node = null;\n  @property(cc.Prefab)\n  listBox: cc.Prefab = null;\n  @property(cc.ScrollView)\n  scrollView: cc.ScrollView = null;\n  @property(cc.Node)\n  nav1: cc.Node = null;\n  @property(cc.Node)\n  nav2: cc.Node = null;\n  @property(cc.Node)\n  emptyBox: cc.Node = null;\n\n  listBoxArr = [];\n  typeObj = {};\n  typeDealObj = {};\n  resultMap = [];\n  resultDealMap = [];\n  activeIndex = 1;\n\n  onLoad() {\n    this.goBack.on('touchstart', this.onGoBack, this);\n    this.initScrollView();\n  }\n\n  private async initScrollView() {\n    State.ins().storeNear.near = await connect(Object.assign(State.ins().storeNearConfig, { deps: { keyStore: new keyStores.BrowserLocalStorageKeyStore() } }));\n    State.ins().storeNear.walletAccount = new WalletAccount(State.ins().storeNear.near);\n    State.ins().storeNear.contract = new Contract(State.ins().storeNear.walletAccount.account(), State.ins().storeNearConfig.contractName, {\n      viewMethods: ['get_sales', 'get_sales_by_owner_id'],\n      changeMethods: ['offer'],\n      sender: State.ins().storeNear.walletAccount.account()\n    });\n    State.ins().storeNear.ownerKey = State.ins().storeNear.walletAccount.getAccountId();\n    let from_index = 0;\n    let limit = 80;\n    let result = [];\n    let awaitResult = async () => {\n      let res = await State.ins().storeNear.contract.get_sales({\n        from_index: from_index.toString(),\n        limit: limit.toString()\n      });\n      result = result.concat(res);\n      if (from_index !== 0 && res.length === 0) {\n        // stop interval\n        return result;\n      } else {\n        from_index += limit;\n        return awaitResult();\n      }\n    };\n    await awaitResult();\n\n    this.typeObj = {};\n    this.typeDealObj = {};\n    this.resultMap = [];\n    this.resultDealMap = [];\n    result.forEach((item, index) => {\n      let type = item.token_id.split(':')[0];\n      if (item.owner_id === 'nftball.testnet') {\n        if (!this.resultMap[type]) {\n          this.resultMap[type] = [];\n        }\n        this.resultMap[type].push(item);\n        if (this.typeObj[type]) {\n          this.typeObj[type] += 1;\n        } else {\n          this.typeObj[type] = 1;\n        }\n      } else {\n        if (!this.resultDealMap[type]) {\n          this.resultDealMap[type] = [];\n        }\n        this.resultDealMap[type].push(item);\n        if (this.typeDealObj[type]) {\n          this.typeDealObj[type] += 1;\n        } else {\n          this.typeDealObj[type] = 1;\n        }\n      }\n    });\n\n    await this.renderDefault();\n\n    await this.judgeEmpty();\n\n    this.nav1.on('touchstart', () => this.onNav(1), this);\n    this.nav2.on('touchstart', () => this.onNav(2), this);\n  }\n\n  private renderDefault() {\n    this.scrollView.content.removeAllChildren();\n    let typeArr = Object.keys(this.typeObj);\n    State.ins().imageList.forEach((item, index) => {\n      if (!typeArr.includes(item.type.toString())) return;\n      item.maxCount = this.typeObj[item.type];\n      item.price = (this.resultMap[item.type][0].conditions.near / 1000000000000000000000000).toString();\n      let listBox = cc.instantiate(this.listBox);\n      this.scrollView.content.addChild(listBox);\n      listBox.getComponent('StoreItem').initBox(item);\n      this.listBoxArr.push(listBox);\n      listBox.on('touchstart', () => {\n        State.ins().storePayObj = this.resultMap[item.type][0];\n        State.ins().storePayIndex = index;\n        this.switchListBox(listBox);\n      });\n    });\n  }\n\n  private renderDeal() {\n    this.scrollView.content.removeAllChildren();\n    let typeDealArr = Object.keys(this.typeDealObj);\n    State.ins()\n      .imageList.concat()\n      .forEach((item, index) => {\n        if (!typeDealArr.includes(item.type.toString())) return;\n        item.price = (this.resultDealMap[item.type][0].conditions.near / 1000000000000000000000000).toString();\n        let listBox = cc.instantiate(this.listBox);\n        this.scrollView.content.addChild(listBox);\n        listBox.getComponent('StoreItem').initBox(item);\n        this.listBoxArr.push(listBox);\n        listBox.on('touchstart', () => {\n          State.ins().storePayObj = this.resultDealMap[item.type][0];\n          State.ins().storePayIndex = index;\n          this.switchListBox(listBox);\n        });\n      });\n  }\n\n  private switchListBox(box) {\n    this.listBoxArr.forEach((item, idx) => {\n      item.getComponent('StoreItem').onListBoxOver();\n      if (item === box) {\n        item.getComponent('StoreItem').onListBox();\n      }\n    });\n  }\n\n  private onGoBack() {\n    cc.director.loadScene('main');\n  }\n\n  private onNav(activeIndex) {\n    this.activeIndex = activeIndex;\n    let label = this[`nav${activeIndex}`].getChildByName('navLabel');\n    label.opacity = 255 * 0.8;\n    let navBg = this[`nav${activeIndex}`].getChildByName('navActive');\n    navBg.active = true;\n\n    let nextActive = 3 - activeIndex;\n    let nextLabel = this[`nav${nextActive}`].getChildByName('navLabel');\n    nextLabel.opacity = 255 * 0.6;\n    let nextNavBg = this[`nav${nextActive}`].getChildByName('navActive');\n    nextNavBg.active = false;\n    this.judgeEmpty();\n  }\n\n  private judgeEmpty() {\n    if (this.activeIndex === 1) {\n      this.renderDefault();\n      this.emptyBox.getChildByName('title').getComponent(cc.Label).string = '当前暂无商城道具';\n    } else {\n      this.renderDeal();\n      this.emptyBox.getChildByName('title').getComponent(cc.Label).string = '当前暂无C2C道具';\n    }\n    this.emptyBox.active = this.scrollView.content.children.length === 0;\n  }\n}\n"]}